<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay eBlotter System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for aesthetic purposes */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 3px;
        }
        /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure main content area expands correctly */
        .main-content-area {
            min-height: calc(100vh - 40px); /* Adjust for fixed footer */
        }
        /* Style for required form fields */
        input:required:not(:placeholder-shown), textarea:required:not(:placeholder-shown) {
            /* Optional: Add a subtle indication that the field is required/filled */
        }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">
    <div id="app-container" class="flex w-full">
        <!-- Sidebar Navigation (Desktop) -->
        <nav id="sidebar" class="hidden sm:flex w-64 bg-blue-800 text-white flex-col p-4 shadow-2xl sticky top-0 h-screen">
            <h1 class="text-2xl font-extrabold mb-8 text-blue-100/90 tracking-wider">
                Barangay eBlotter
            </h1>
            
            <!-- Navigation items will be inserted here by JS -->
            <div id="nav-items"></div>

            <div class="mt-auto pt-6 border-t border-blue-700">
                <p class="text-xs text-blue-300 mb-2">Authenticated User</p>
                <div class="bg-blue-700 p-3 rounded-lg text-sm">
                    <p class="font-semibold" id="current-role-display">Barangay Captain</p>
                    <p class="text-xs break-all mt-1">ID: <span id="user-id-display">Loading...</span></p>
                </div>
                
                <div class="mt-4">
                    <label for="role-switcher" class="block text-sm font-medium text-blue-300 mb-1">Change Role (Demo)</label>
                    <select id="role-switcher" class="w-full p-2 border border-gray-300 bg-blue-700 text-white rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                        <!-- Options filled by JS -->
                    </select>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col">
            <!-- Header (Mobile Only) -->
            <header class="bg-blue-700 text-white p-4 flex items-center justify-between shadow-lg sm:hidden sticky top-0 z-30">
                <h1 class="text-lg font-bold">eBlotter System</h1>
                <!-- Simple Mobile Menu Placeholder -->
                <button id="mobile-menu-toggle" class="p-2 rounded-full hover:bg-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
            </header>
            
            <!-- Content Area -->
            <main id="main-content" class="flex-1 p-4 sm:p-8 overflow-y-auto main-content-area">
                <!-- Content injected here -->
            </main>
            
            <!-- Footer with Credit -->
            <footer class="bg-white border-t border-gray-200 p-2 text-center text-xs text-gray-500">
                &copy; 2025 Barangay eBlotter System. All Rights Reserved by <strong>Noel Timario</strong>.
            </footer>
        </div>

        <!-- Modals and Chatbot will be appended to body or app-container -->
        <div id="modal-root"></div>
        <div id="chatbot-root"></div>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP (MANDATORY CANVAS VARIABLES) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-barangay-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- APPLICATION STATE ---
        const state = {
            db: null,
            auth: null,
            userId: null,
            isAuthReady: false,
            currentView: 'dashboard',
            blotterEntries: [],
            currentRole: 'Barangay Captain',
            isFormOpen: false,
            isEditing: false,
            currentEntry: null,
            searchQuery: '',
            chatMessages: [
                { sender: 'bot', text: "Hello! I'm the Barangay eBlotter Assistant. How can I help you today? Please select: **Submit a New Report** or **Check Report Status**." }
            ],
            isChatbotOpen: false,
        };

        // --- CONSTANTS ---
        const USER_ROLES = ['Barangay Captain', 'Secretary', 'Staff'];
        const BLOTTER_COLLECTION_PATH = `artifacts/${appId}/public/data/blotter_entries`;

        // --- UTILITY FUNCTIONS ---

        /** Simple helper for creating DOM elements. */
        const createElement = (tag, attributes = {}, children = []) => {
            const el = document.createElement(tag);
            Object.keys(attributes).forEach(key => {
                if (key.startsWith('on')) {
                    el.addEventListener(key.slice(2).toLowerCase(), attributes[key]);
                } else if (key === 'className') {
                    el.className = attributes[key];
                } else {
                    el.setAttribute(key, attributes[key]);
                }
            });
            children.forEach(child => {
                if (typeof child === 'string') {
                    el.appendChild(document.createTextNode(child));
                } else {
                    el.appendChild(child);
                }
            });
            return el;
        };

        /** Generates a case number. */
        const generateCaseNumber = () => {
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `INC-${timestamp}-${random}`;
        };

        /** Icons (using inline SVG) */
        const getIcon = (name, className = 'w-5 h-5') => {
            const icons = {
                LayoutDashboard: '<path d="M3 3h18v18H3zM3 9h18M9 21V9"/>',
                FileText: '<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7l-5-5z"/><path d="M10 12h4"/><path d="M10 16h4"/><path d="M15 2v5h5"/>',
                ClipboardList: '<rect x="9" y="4" width="6" height="4" rx="1" ry="1"/><path d="M8 7H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-4"/><path d="M12 11h4"/><path d="M12 15h4"/><path d="M8 15h.01"/><path d="M8 11h.01"/>',
                BarChart: '<line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/>',
                Bot: '<path d="M12 8V4"/><rect x="2" y="4" width="20" height="12" rx="2"/><path d="M2 10h20"/><path d="M8 16c0 1.5 1 2 4 2s4-.5 4-2"/><path d="M10 9l.01 0"/><path d="M14 9l.01 0"/>',
                Trash2: '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 2v2"/><path d="M9 2v2"/>',
                Edit: '<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>',
                Download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',
                User: '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
                Check: '<polyline points="20 6 9 17 4 12"/>',
                X: '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
            };
            const path = icons[name] || '';
            return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${path}</svg>`;
        };

        /** Simple retry wrapper for Firestore operations. */
        const callWithRetry = async (fn, maxRetries = 3) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        console.error("Firebase operation failed after max retries:", error);
                        throw error;
                    }
                }
            }
        };

        // --- RENDERING COMPONENTS ---

        /** Renders a KPI card. */
        const renderCard = (title, value, iconName, color) => {
            const card = createElement('div', {
                className: 'bg-white p-5 rounded-xl shadow-lg border-b-4 border-l-2 border-gray-100 transition-all duration-300 hover:shadow-xl'
            });
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500">${title}</p>
                        <h3 class="mt-1 text-2xl font-extrabold text-gray-900 truncate">${value}</h3>
                    </div>
                    <div class="p-3 rounded-full ${color} text-white bg-opacity-80">
                        ${getIcon(iconName, 'w-6 h-6')}
                    </div>
                </div>
            `;
            return card;
        };

        /** Renders the Dashboard View. */
        const renderDashboard = () => {
            const entries = state.blotterEntries;
            const totalCases = entries.length;
            const openCases = entries.filter(e => e.status === 'Open').length;
            const resolvedCases = entries.filter(e => e.status === 'Resolved').length;

            const content = createElement('div', { className: 'space-y-6' });
            content.innerHTML = '<h2 class="text-3xl font-bold text-gray-800">Barangay Operations Dashboard</h2>';

            // KPI Cards
            const cardGrid = createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4' });
            cardGrid.appendChild(renderCard("Total Recorded Cases", totalCases, "ClipboardList", "bg-blue-600"));
            cardGrid.appendChild(renderCard("Open Cases (Urgent)", openCases, "FileText", "bg-red-600"));
            cardGrid.appendChild(renderCard("Resolved Cases", resolvedCases, "Check", "bg-green-600"));
            
            // Simulated AI Analytics
            const hotSpotLocations = entries.map(e => e.location || 'Undisclosed').reduce((acc, loc) => {
                acc[loc] = (acc[loc] || 0) + 1; return acc;
            }, {});
            const sortedHotSpots = Object.entries(hotSpotLocations).sort(([, a], [, b]) => b - a);
            const hotSpot = sortedHotSpots.length > 0 ? sortedHotSpots[0][0] : 'N/A';
            cardGrid.appendChild(renderCard("AI Detected Hotspot", hotSpot, "BarChart", "bg-purple-600"));

            content.appendChild(cardGrid);

            // Detailed Panel (Simulated Chart/Analytics)
            const detailPanel = createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-6' });

            const statusData = [
                { name: 'Open', count: openCases, color: 'bg-red-500' },
                { name: 'Resolved', count: resolvedCases, color: 'bg-green-500' },
                { name: 'Referred', count: totalCases - openCases - resolvedCases, color: 'bg-yellow-500' },
            ];
            
            // Status Breakdown
            const breakdown = createElement('div', { className: 'lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-100' });
            breakdown.innerHTML = '<h3 class="text-xl font-semibold mb-4 text-gray-700">Case Status Breakdown</h3>';
            
            const chart = createElement('div', { className: 'h-48 flex items-end justify-between space-x-4 pt-4' });
            statusData.forEach(item => {
                const heightPercentage = (item.count / totalCases) * 100 || 0;
                const bar = createElement('div', { className: 'flex flex-col items-center w-full' });
                bar.innerHTML = `
                    <div class="w-full ${item.color} rounded-t-lg transition-all duration-500 hover:opacity-80" 
                         style="height: ${heightPercentage}%; max-height: 100%; min-height: 10px;">
                    </div>
                    <p class="mt-2 text-sm font-medium text-gray-600">${item.name}</p>
                    <p class="text-lg font-bold text-gray-800">${item.count}</p>
                `;
                chart.appendChild(bar);
            });
            breakdown.appendChild(chart);
            detailPanel.appendChild(breakdown);

            // AI Summary
            const aiSummary = createElement('div', { className: 'lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100' });
            aiSummary.innerHTML = `
                <h3 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                    ${getIcon('Bot', 'w-6 h-6 mr-2 text-purple-600')} AI Analytics Summary
                </h3>
                <div class="space-y-4">
                    <p><strong>Top Hotspot:</strong> <span class="text-purple-600 font-medium">${hotSpot}</span></p>
                    <p><strong>System Alert:</strong> <span class="${openCases > 5 ? 'text-red-500' : 'text-green-500'} font-medium">${openCases > 5 ? 'High volume of Open Cases.' : 'Case load is stable.'}</span></p>
                    <p class="text-sm text-gray-500 mt-4 border-t pt-3">
                        *Insights generated from simulated case pattern recognition.
                    </p>
                </div>
            `;
            detailPanel.appendChild(aiSummary);

            content.appendChild(detailPanel);
            return content;
        };

        /** Renders the Blotter Management View. */
        const renderBlotterManager = () => {
            const entries = state.blotterEntries.filter(entry => 
                entry.caseNumber.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                entry.complainant.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                entry.description.toLowerCase().includes(state.searchQuery.toLowerCase())
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            const container = createElement('div', { className: 'space-y-6' });
            container.innerHTML = '<h2 class="text-3xl font-bold text-gray-800">Digital Blotter & Case Management</h2>';

            // Top bar (New Entry button and Search)
            const topBar = createElement('div', { className: 'flex flex-col sm:flex-row justify-between items-center gap-3' });
            
            const newButton = createElement('button', {
                className: 'w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center',
                onclick: () => openBlotterForm(false),
            });
            newButton.innerHTML = `${getIcon('FileText', 'w-5 h-5 mr-2')} New Blotter Entry`;
            topBar.appendChild(newButton);

            const searchInput = createElement('input', {
                type: 'text',
                placeholder: 'Search by Case #, Complainant, or Keyword...',
                value: state.searchQuery,
                oninput: (e) => { state.searchQuery = e.target.value; renderApp(); },
                className: 'w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition',
            });
            topBar.appendChild(searchInput);
            container.appendChild(topBar);

            // Table
            const tableContainer = createElement('div', { className: 'bg-white rounded-xl shadow-lg overflow-hidden' });
            const table = createElement('table', { className: 'min-w-full divide-y divide-gray-200' });
            tableContainer.appendChild(table);
            container.appendChild(tableContainer);

            // Table Header
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Case #</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Complainant</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="blotter-table-body" class="bg-white divide-y divide-gray-200">
                    ${entries.length === 0 ? `<tr><td colSpan="5" class="px-6 py-4 text-center text-gray-500">No blotter entries found.</td></tr>` : ''}
                </tbody>
            `;

            const tbody = table.querySelector('#blotter-table-body');
            entries.forEach(entry => {
                const row = createElement('tr', { className: 'hover:bg-blue-50 transition-colors' });

                const statusClass = entry.status === 'Open' ? 'bg-red-100 text-red-800' : 
                                    entry.status === 'Resolved' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                
                // Actions container
                const actionsContainer = createElement('div', { className: 'flex space-x-2' });

                // Edit Button
                const editButton = createElement('button', {
                    title: 'Edit',
                    className: 'text-blue-600 hover:text-blue-900 p-1 rounded-full hover:bg-blue-100 transition-colors',
                    onclick: () => openBlotterForm(true, entry)
                });
                editButton.innerHTML = getIcon('Edit', 'w-5 h-5');
                actionsContainer.appendChild(editButton);

                // Status Toggle Button
                const isResolved = entry.status === 'Resolved';
                const newStatus = isResolved ? 'Open' : 'Resolved';
                const statusButton = createElement('button', {
                    title: isResolved ? 'Reopen Case' : 'Resolve Case',
                    className: `${isResolved ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'} p-1 rounded-full hover:bg-gray-100 transition-colors`,
                    onclick: () => handleUpdateStatus(entry, newStatus)
                });
                statusButton.innerHTML = getIcon(isResolved ? 'X' : 'Check', 'w-5 h-5');
                actionsContainer.appendChild(statusButton);

                // Delete Button
                if (['Barangay Captain', 'Secretary'].includes(state.currentRole)) {
                    const deleteButton = createElement('button', {
                        title: 'Delete',
                        className: 'text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100 transition-colors',
                        onclick: () => handleDelete(entry.id)
                    });
                    deleteButton.innerHTML = getIcon('Trash2', 'w-5 h-5');
                    actionsContainer.appendChild(deleteButton);
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${entry.caseNumber}
                        <div class="text-xs text-gray-500 block sm:hidden">${entry.type}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${entry.complainant}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden sm:table-cell">${entry.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${entry.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"></td>
                `;
                row.lastElementChild.appendChild(actionsContainer);
                tbody.appendChild(row);
            });

            return container;
        };

        /** Renders the Report Generator View. */
        const renderReports = () => {
             const entries = state.blotterEntries;
             const content = createElement('div', { className: 'space-y-6' });
             content.innerHTML = '<h2 class="text-3xl font-bold text-gray-800">Automated Report Generation</h2>';

             const reportTypeOptions = ['Daily', 'Monthly', 'Annual', 'All Time'];
             let currentReportType = 'Monthly'; // Use a local variable for this render cycle

             const reportContainer = createElement('div', { className: 'bg-white p-6 rounded-xl shadow-lg border border-gray-100 space-y-4' });
             
             const topSection = createElement('div', { className: 'flex flex-col sm:flex-row gap-3 items-center justify-between' });
             
             const selectWrapper = createElement('div', { className: 'w-full sm:w-64' });
             selectWrapper.innerHTML = `
                 <label for="report-type-select" class="block text-sm font-medium text-gray-700 mb-1">Select Report Type</label>
                 <select id="report-type-select" class="w-full p-2 border border-gray-300 bg-white rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                     ${reportTypeOptions.map(opt => `<option value="${opt}" ${opt === currentReportType ? 'selected' : ''}>${opt}</option>`).join('')}
                 </select>
             `;
             topSection.appendChild(selectWrapper);
             
             const buttonGroup = createElement('div', { className: 'flex space-x-3 w-full sm:w-auto' });
             
             const generateButton = (label, color, format) => {
                 const btn = createElement('button', {
                     className: `flex items-center px-4 py-2 ${color} text-white font-semibold rounded-lg hover:opacity-80 transition-colors disabled:opacity-50`,
                     onclick: () => handleGenerateReport(currentReportType, format),
                     disabled: !['Barangay Captain', 'Secretary'].includes(state.currentRole)
                 });
                 btn.innerHTML = `${getIcon('Download', 'w-5 h-5 mr-2')} Export ${label}`;
                 return btn;
             };

             buttonGroup.appendChild(generateButton('PDF', 'bg-red-600', 'PDF'));
             buttonGroup.appendChild(generateButton('Excel', 'bg-green-600', 'Excel'));
             topSection.appendChild(buttonGroup);
             reportContainer.appendChild(topSection);

             // Report Preview Placeholder
             const reportPreview = createElement('div', { id: 'report-preview', className: 'mt-6 border-t pt-4' });
             
             const updateReportPreview = (type) => {
                const now = new Date();
                const filtered = entries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    if (type === 'Daily') return entryDate.toDateString() === now.toDateString();
                    if (type === 'Monthly') return entryDate.getMonth() === now.getMonth() && entryDate.getFullYear() === now.getFullYear();
                    if (type === 'Annual') return entryDate.getFullYear() === now.getFullYear();
                    return true;
                });

                const statusSummary = filtered.reduce((acc, entry) => {
                    acc[entry.status] = (acc[entry.status] || 0) + 1;
                    return acc;
                }, {});

                reportPreview.innerHTML = `
                    <h3 class="text-xl font-semibold mb-3">Report Preview: ${type}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4" id="report-kpis">
                        ${renderCard("Total Cases", filtered.length, "ClipboardList", "bg-blue-500").outerHTML}
                        ${renderCard("Open Cases", statusSummary.Open || 0, "FileText", "bg-red-500").outerHTML}
                        ${renderCard("Resolved Cases", statusSummary.Resolved || 0, "Check", "bg-green-500").outerHTML}
                    </div>
                    <p class="text-sm text-gray-500 mt-4">Showing ${filtered.length} entries for the selected period.</p>
                `;
             };

             // Initial preview render and listener setup
             updateReportPreview(currentReportType);

             selectWrapper.querySelector('#report-type-select').addEventListener('change', (e) => {
                 currentReportType = e.target.value;
                 updateReportPreview(currentReportType);
             });

             reportContainer.appendChild(reportPreview);
             content.appendChild(reportContainer);
             return content;
        };
        
        // --- HANDLERS (CRUD & LOGIC) ---
        
        /** Global function to handle view change */
        const changeView = (viewName) => {
            state.currentView = viewName;
            renderApp();
        };

        /** Opens the blotter form modal */
        const openBlotterForm = (isEditing, entry = null) => {
            state.isEditing = isEditing;
            state.currentEntry = entry ? {...entry} : {
                caseNumber: generateCaseNumber(),
                type: 'Complaint',
                date: new Date().toISOString().substring(0, 10),
                complainant: '',
                location: '',
                description: '',
                status: 'Open',
                recordedBy: state.userId,
                role: state.currentRole,
            };
            state.isFormOpen = true;
            renderModal();
        };

        /** Closes the blotter form modal */
        const closeBlotterForm = () => {
            state.isFormOpen = false;
            state.currentEntry = null;
            renderModal();
        };

        /** Handles blotter entry submission (Add/Update) */
        const handleBlotterSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const loadingButton = form.querySelector('button[type="submit"]');
            loadingButton.disabled = true;
            loadingButton.innerHTML = 'Saving...';

            const formData = {
                caseNumber: form.caseNumber.value,
                type: form.type.value,
                date: form.date.value,
                complainant: form.complainant.value,
                location: form.location.value,
                description: form.description.value,
                status: form.status.value,
                recordedBy: state.isEditing ? state.currentEntry.recordedBy : state.userId,
                role: state.isEditing ? state.currentEntry.role : state.currentRole,
            };

            try {
                if (state.isEditing) {
                    const docRef = doc(state.db, BLOTTER_COLLECTION_PATH, state.currentEntry.id);
                    await callWithRetry(() => updateDoc(docRef, formData));
                    console.log("Document updated successfully!");
                } else {
                    await callWithRetry(() => addDoc(collection(state.db, BLOTTER_COLLECTION_PATH), formData));
                    console.log("Document added successfully!");
                }
                closeBlotterForm();
            } catch (error) {
                console.error("Error saving document: ", error);
                alert(`Error saving entry: ${error.message}`);
            }
        };

        /** Handles deletion of a blotter entry */
        const handleDelete = async (id) => {
            if (!['Barangay Captain', 'Secretary'].includes(state.currentRole)) {
                alert('Authorization failed: Only Captain or Secretary can delete records.');
                return;
            }

            if (window.confirm('Are you sure you want to delete this blotter entry? This action cannot be undone.')) {
                try {
                    const docRef = doc(state.db, BLOTTER_COLLECTION_PATH, id);
                    await callWithRetry(() => deleteDoc(docRef));
                    console.log("Document successfully deleted!");
                } catch (error) {
                    console.error("Error deleting document: ", error);
                }
            }
        };

        /** Handles status update of a blotter entry */
        const handleUpdateStatus = async (entry, newStatus) => {
            if (!['Barangay Captain', 'Secretary'].includes(state.currentRole) && newStatus !== 'Open') {
                alert('Authorization failed: Only Captain or Secretary can change status from Open.');
                return;
            }

            try {
                const docRef = doc(state.db, BLOTTER_COLLECTION_PATH, entry.id);
                await callWithRetry(() => updateDoc(docRef, { status: newStatus }));
                console.log("Status successfully updated!");
            } catch (error) {
                console.error("Error updating status: ", error);
            }
        };

        /** Handles report generation (simulated) */
        const handleGenerateReport = (type, format) => {
            if (!['Barangay Captain', 'Secretary'].includes(state.currentRole)) {
                alert('Authorization failed: Only Captain or Secretary can generate reports.');
                return;
            }
            alert(`Simulating generation of ${type} Report in ${format} format. This is a demo feature.`);
        };
        
        /** Handles simulated file change */
        const handleFileChange = (e) => {
            if (e.target.files.length > 0) {
                alert(`File '${e.target.files[0].name}' selected. NOTE: Actual file upload to cloud storage is disabled in this demo.`);
            }
        };

        // --- CORE RENDER FUNCTION ---

        /** Main function to render the entire application based on state. */
        const renderApp = () => {
            if (!state.isAuthReady) {
                 document.getElementById('main-content').innerHTML = `
                    <div class="flex justify-center items-center h-full min-h-[50vh]">
                        <div class="p-8 bg-white rounded-xl shadow-xl text-lg font-medium text-blue-600">
                            Initializing System & Authenticating User...
                        </div>
                    </div>
                `;
                return;
            }

            // Update Sidebar/User Info
            document.getElementById('user-id-display').textContent = state.userId || 'N/A';
            document.getElementById('current-role-display').textContent = state.currentRole;
            
            // Render Navigation
            const navItemsContainer = document.getElementById('nav-items');
            navItemsContainer.innerHTML = '';
            const navItems = [
                { name: 'Dashboard', view: 'dashboard', icon: 'LayoutDashboard' },
                { name: 'Case Management', view: 'blotter', icon: 'ClipboardList' },
                { name: 'Reports', view: 'reports', icon: 'FileText' },
            ];
            navItems.forEach(item => {
                const button = createElement('button', {
                    className: `flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 mb-2 w-full
                        ${state.currentView === item.view 
                            ? 'bg-blue-600 font-bold shadow-md' 
                            : 'hover:bg-blue-700/70'
                        }`,
                    onclick: () => changeView(item.view)
                });
                button.innerHTML = `${getIcon(item.icon, 'w-5 h-5')} <span class="text-base">${item.name}</span>`;
                navItemsContainer.appendChild(button);
            });

            // Render Role Switcher
            const roleSwitcher = document.getElementById('role-switcher');
            roleSwitcher.innerHTML = USER_ROLES.map(role => 
                `<option value="${role}" ${role === state.currentRole ? 'selected' : ''}>${role}</option>`
            ).join('');
            roleSwitcher.onchange = (e) => { state.currentRole = e.target.value; renderApp(); };

            // Render Main Content
            const mainContent = document.getElementById('main-content');
            let contentElement;
            switch (state.currentView) {
                case 'dashboard':
                    contentElement = renderDashboard();
                    break;
                case 'blotter':
                    contentElement = renderBlotterManager();
                    break;
                case 'reports':
                    contentElement = renderReports();
                    break;
                default:
                    contentElement = renderDashboard();
            }
            mainContent.innerHTML = '';
            mainContent.appendChild(contentElement);

            // Render Modals and Chatbot
            renderModal();
            renderChatbot();
        };

        /** Renders the Blotter Form Modal */
        const renderModal = () => {
            const modalRoot = document.getElementById('modal-root');
            modalRoot.innerHTML = '';

            if (!state.isFormOpen) return;

            const entry = state.currentEntry;
            const isEditing = state.isEditing;
            const title = isEditing ? 'Edit Blotter Entry' : 'New Blotter Entry';
            
            const modal = createElement('div', {
                className: 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4',
                onclick: closeBlotterForm
            });

            const modalContent = createElement('div', {
                className: 'bg-white w-full max-w-2xl rounded-xl shadow-2xl transition-all transform scale-100 max-h-[90vh] overflow-y-auto',
                onclick: (e) => e.stopPropagation()
            });

            const form = createElement('form', { onsubmit: handleBlotterSubmit, className: 'p-6 space-y-4' });

            // Form Fields
            form.innerHTML = `
                <div class="p-6 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <h3 class="text-2xl font-bold text-gray-800">${title}</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Case Number</label>
                            <input name="caseNumber" value="${entry.caseNumber}" readonly class="w-full p-2 border bg-gray-50 border-gray-200 rounded-lg transition" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Incident/Complaint <span class="text-red-500">*</span></label>
                            <input type="date" name="date" value="${entry.date}" required class="w-full p-2 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-lg transition" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select name="type" class="w-full p-2 border border-gray-300 bg-white rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                                ${['Complaint', 'Incident', 'Dispute'].map(opt => `<option value="${opt}" ${opt === entry.type ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select name="status" class="w-full p-2 border border-gray-300 bg-white rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
                                ${['Open', 'Resolved', 'Referred'].map(opt => `<option value="${opt}" ${opt === entry.status ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Complainant/Victim Name <span class="text-red-500">*</span></label>
                        <input name="complainant" value="${entry.complainant}" required class="w-full p-2 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-lg transition" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location/Hotspot (Purok/Street)</label>
                        <input name="location" value="${entry.location || ''}" class="w-full p-2 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 rounded-lg transition" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Detailed Description of Incident/Complaint <span class="text-red-500">*</span></label>
                        <textarea name="description" rows="4" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">${entry.description}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Upload Supporting Files (Simulated)</label>
                        <input type="file" onchange="handleFileChange(event)" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors"/>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeBlotterForm()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center">
                            ${isEditing ? 'Save Changes' : 'Record Entry'}
                        </button>
                    </div>
                </div>
            `;

            modalContent.appendChild(form);
            modal.appendChild(modalContent);
            modalRoot.appendChild(modal);

            // Export close function globally for use in form buttons
            window.closeBlotterForm = closeBlotterForm;
            window.handleFileChange = handleFileChange;
        };
        
        /** Renders the Chatbot Widget */
        const renderChatbot = () => {
            const root = document.getElementById('chatbot-root');
            root.innerHTML = '';
            
            const container = createElement('div', {
                className: `fixed bottom-4 right-4 z-40 transition-all duration-300 ${state.isChatbotOpen ? 'w-80 h-96' : 'w-16 h-16'}`
            });

            // Chat Window (only visible if open)
            if (state.isChatbotOpen) {
                const chatWindow = createElement('div', { className: 'bg-white rounded-xl shadow-2xl border border-gray-200 flex flex-col h-full overflow-hidden' });
                
                // Header
                const header = createElement('div', { className: 'bg-blue-600 text-white p-3 flex justify-between items-center rounded-t-xl' });
                header.innerHTML = `<h4 class="font-semibold flex items-center">${getIcon('Bot', 'w-5 h-5 mr-2')} eBlotter Assistant</h4>`;
                
                const closeBtn = createElement('button', { className: 'text-white hover:text-gray-200', onclick: () => { state.isChatbotOpen = false; renderChatbot(); } });
                closeBtn.innerHTML = getIcon('X', 'w-5 h-5');
                header.appendChild(closeBtn);
                chatWindow.appendChild(header);

                // Messages area
                const messagesArea = createElement('div', { id: 'chat-messages-area', className: 'flex-1 p-3 space-y-3 overflow-y-auto text-sm custom-scrollbar' });
                state.chatMessages.forEach(msg => {
                    const msgDiv = createElement('div', { className: `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}` });
                    const content = msg.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    msgDiv.innerHTML = `
                        <div class="max-w-[80%] px-3 py-2 rounded-xl shadow-sm ${
                            msg.sender === 'user' ? 'bg-blue-100 text-gray-800' : 'bg-gray-100 text-gray-700'
                        }">${content}</div>
                    `;
                    messagesArea.appendChild(msgDiv);
                });
                chatWindow.appendChild(messagesArea);

                // Input area
                const inputArea = createElement('div', { className: 'p-3 border-t border-gray-200 flex' });
                const inputField = createElement('input', {
                    type: 'text',
                    placeholder: 'Type your message...',
                    className: 'flex-1 p-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500 text-sm',
                });
                const sendBtn = createElement('button', { 
                    className: 'px-3 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700 transition-colors',
                    onclick: () => handleChatSend(inputField.value, inputField)
                }, ['Send']);

                inputField.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        handleChatSend(inputField.value, inputField);
                    }
                });

                inputArea.appendChild(inputField);
                inputArea.appendChild(sendBtn);
                chatWindow.appendChild(inputArea);

                container.appendChild(chatWindow);

                // Scroll to bottom on open/new message
                setTimeout(() => {
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }, 100);
            }

            // Toggle Button
            const toggleBtn = createElement('button', { 
                className: `absolute bottom-0 right-0 p-4 rounded-full shadow-lg transition-all duration-300 transform 
                    ${state.isChatbotOpen ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'} text-white`,
                title: state.isChatbotOpen ? 'Close Chatbot' : 'Open Chatbot',
                onclick: () => { state.isChatbotOpen = !state.isChatbotOpen; renderChatbot(); }
            });
            toggleBtn.innerHTML = getIcon('Bot', 'w-7 h-7');
            container.appendChild(toggleBtn);
            
            root.appendChild(container);
        };
        
        /** Chatbot message handler */
        const handleChatSend = (userMessage, inputField) => {
            if (!userMessage.trim()) return;

            // 1. Add user message
            state.chatMessages.push({ sender: 'user', text: userMessage });
            inputField.value = '';
            renderChatbot(); // Re-render to show user message

            // 2. Simulate Bot Response
            const lowerMsg = userMessage.toLowerCase();
            let botResponse;

            if (lowerMsg.includes('new report') || lowerMsg.includes('submit')) {
                botResponse = "To submit a new report, please visit the Barangay Hall or use the dedicated 'New Blotter Entry' button on the main system (if you are a registered official). If you are a resident, please proceed to the Barangay Hall immediately to file the incident report in person.";
            } else if (lowerMsg.includes('status') || lowerMsg.includes('check')) {
                botResponse = "To check your report status, please provide your 6-digit Case ID (e.g., INC-123456-ABC).";
            } else if (lowerMsg.includes('inc-')) {
                 botResponse = `Case ID ${userMessage.toUpperCase()} found. Status: **Pending initial assessment**. Please wait for a Barangay Official to update the record.`;
            } else {
                botResponse = "I'm sorry, I don't understand that. Please try 'Submit a New Report' or 'Check Report Status'.";
            }

            setTimeout(() => {
                state.chatMessages.push({ sender: 'bot', text: botResponse });
                renderChatbot(); // Re-render to show bot message
            }, 1000);
        };

        // --- FIREBASE INITIALIZATION & DATA LISTENER ---

        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                state.db = getFirestore(app);
                state.auth = getAuth(app);
                
                // setLogLevel('debug'); // Uncomment for Firestore debugging

                // Authentication Handler
                onAuthStateChanged(state.auth, async (user) => {
                    if (user) {
                        state.userId = user.uid;
                    } else {
                        // Sign in anonymously or with custom token
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(state.auth, initialAuthToken);
                                state.userId = state.auth.currentUser.uid;
                            } else {
                                const anonUser = await signInAnonymously(state.auth);
                                state.userId = anonUser.user.uid;
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            state.userId = crypto.randomUUID();
                        }
                    }
                    state.isAuthReady = true;
                    renderApp(); // Initial render after auth is ready
                    setupFirestoreListener();
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                state.isAuthReady = true;
                renderApp(); // Render error state
            }
        };

        const setupFirestoreListener = () => {
            if (!state.db || !state.isAuthReady) return;

            const blotterQuery = query(collection(state.db, BLOTTER_COLLECTION_PATH));

            // Real-time listener
            onSnapshot(blotterQuery, (snapshot) => {
                state.blotterEntries = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log("Fetched blotter entries:", state.blotterEntries.length);
                renderApp(); // Re-render application whenever data changes
            }, (error) => {
                console.error("Error listening to blotter entries:", error);
            });
        };

        // --- INITIAL STARTUP ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>
